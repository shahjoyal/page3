<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Coal Blending Ratio</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #000;
      color: #0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 30px;
    }
    h1 {
      color: yellow;
      margin: 15px auto;
      font-size: 2vw;
      text-align: center;
    }
    .upload-btn {
      display: inline-block;
      background: #020947;
      color: #fff;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin: 15px 5px;
      border: none;
    }
    .main-container {
      display: flex;
      gap: 30px;
      width: 100%;
      justify-content: center;
      align-items: flex-start;
    }
    .mills-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin: 20px 0;
      align-items: center;
      font-size: 1vw;
      width: 65vw;
    }
    .mill {
      background: #111;
      border: 1px solid #555;
      text-align: center;
      padding: 6px;
      color: white;
      min-height: 40px;
    }
    .mill.red { background: #a00; }
    .dropdown {
      width: 100%;
      padding: 5px;
      background: #000;
      color: #0f0;
      border: 1px solid #555;
      font-size: 0.9vw;
    }
    .percentage-input, .coal-input, .cost-input {
      width: 90%;
      padding: 5px;
      background: #000;
      border: 1px solid #0f0;
      color: #0f0;
      text-align: center;
      font-size: 0.8vw;
    }
    /* Coal Flow input boxes */
    .coal-input { border: 2px solid yellow; font-weight: bold; }

    /* Cost & Generation inputs styled same as Coal Flow */
    .cost-input { border: 2px solid yellow; font-weight: bold; color: yellow; }

    /* GCV row styled same as Blended GCV */
    .gcv-box {
      width: 90%;
      padding: 5px;
      text-align: center;
      font-size: 0.8vw;
      font-weight: bold;
    }
    #loader { display: none; margin: 15px 0; color: yellow; font-size: 1.2em; text-align: left; }

    .summary-table {
      display: grid;
      grid-template-columns: 150px 120px;
      gap: 5px;
      font-size: 0.9vw;
      margin-top: 20px;
    }
    .summary-cell {
      background: #111;
      border: 1px solid #555;
      padding: 8px;
      color: white;
      text-align: center;
    }
    .summary-header {
      background: #333;
      font-weight: bold;
      color: white;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

  <div class="center">
    <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="display:none" />
    <label for="excelFile" class="upload-btn">Upload Excel</label>
  </div>

  <h1>COAL BLENDING RATIO</h1>
  <div id="loader">Loading... please wait</div>

  <div class="main-container">
    <!-- Main Mills Table -->
    <div class="mills-grid" id="millsGrid">
      <div></div>
      <div class="mill"><select class="dropdown" id="coalDrop1"></select></div>
      <div class="mill"><select class="dropdown" id="coalDrop2"></select></div>
      <div class="mill"><select class="dropdown" id="coalDrop3"></select></div>
      <div class="mill">Coal Flow</div>
      <div class="mill">Blended GCV</div>
      <div class="mill">AFT</div>

      <!-- Mills A to F -->
      <div class="mill red">MILL-A</div>
      <div class="mill"><input type="text" class="percentage-input"></div>
      <div class="mill"><input type="text" class="percentage-input"></div>
      <div class="mill"><input type="text" class="percentage-input"></div>
      <div class="mill"><input type="text" class="coal-input"></div>
      <div class="mill blended-gcv">0</div>
      <div class="mill aft">--</div>

      <div class="mill red">MILL-B</div>
      <div class="mill"><input type="text" class="percentage-input"></div>
      <div class="mill"><input type="text" class="percentage-input"></div>
      <div class="mill"><input type="text" class="percentage-input"></div>
      <div class="mill"><input type="text" class="coal-input"></div>
      <div class="mill blended-gcv">0</div>
      <div class="mill aft">--</div>

      <div class="mill red">MILL-C</div>
      <div class="mill"><input type="text" class="percentage-input"></div>
      <div class="mill"><input type="text" class="percentage-input"></div>
      <div class="mill"><input type="text" class="percentage-input"></div>
      <div class="mill"><input type="text" class="coal-input"></div>
      <div class="mill blended-gcv">0</div>
      <div class="mill aft">--</div>

      <div class="mill red">MILL-D</div>
      <div class="mill"><input type="text" class="percentage-input"></div>
      <div class="mill"><input type="text" class="percentage-input"></div>
      <div class="mill"><input type="text" class="percentage-input"></div>
      <div class="mill"><input type="text" class="coal-input"></div>
      <div class="mill blended-gcv">0</div>
      <div class="mill aft">--</div>

      <div class="mill red">MILL-E</div>
      <div class="mill"><input type="text" class="percentage-input"></div>
      <div class="mill"><input type="text" class="percentage-input"></div>
      <div class="mill"><input type="text" class="percentage-input"></div>
      <div class="mill"><input type="text" class="coal-input"></div>
      <div class="mill blended-gcv">0</div>
      <div class="mill aft">--</div>

      <div class="mill red">MILL-F</div>
      <div class="mill"><input type="text" class="percentage-input"></div>
      <div class="mill"><input type="text" class="percentage-input"></div>
      <div class="mill"><input type="text" class="percentage-input"></div>
      <div class="mill"><input type="text" class="coal-input"></div>
      <div class="mill blended-gcv">0</div>
      <div class="mill aft">--</div>

      <!-- GCV row -->
      <div class="mill">GCV</div>
      <div class="mill"><div class="gcv-box" id="gcvBox1">--</div></div>
      <div class="mill"><div class="gcv-box" id="gcvBox2">--</div></div>
      <div class="mill"><div class="gcv-box" id="gcvBox3">--</div></div>
      <div></div><div></div><div></div>

      <!-- Cost row -->
      <div class="mill">Cost</div>
      <div class="mill"><input type="text" class="cost-input"></div>
      <div class="mill"><input type="text" class="cost-input"></div>
      <div class="mill"><input type="text" class="cost-input"></div>
      <div></div><div></div><div></div>

      <!-- Generation row -->
      <div class="mill">Generation</div>
      <div class="mill"><input type="text" class="cost-input" id="generation" placeholder="MW"></div>
      <div></div><div></div><div></div><div></div><div></div>
    </div>

    <!-- Summary Table -->
    <div class="summary-table">
      <div class="summary-cell summary-header">Total Coal Flow</div>
      <div class="summary-cell" id="totalFlow">0</div>
      <div class="summary-cell summary-header">Average Blended GCV</div>
      <div class="summary-cell" id="avgGCV">0</div>
      <div class="summary-cell summary-header">Average AFT</div>
      <div class="summary-cell" id="avgAFT">--</div>
      <div class="summary-cell summary-header">Heat Rate</div>
      <div class="summary-cell" id="heatRate">--</div>
    </div>
  </div>

<script>
  let excelData = [];
  document.getElementById("excelFile").addEventListener("change", handleFile, false);

  function handleFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById("loader").style.display = "block"; 
    const reader = new FileReader();
    reader.onload = function(event) {
      setTimeout(() => {   
        try {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          excelData = XLSX.utils.sheet_to_json(worksheet, { defval: 0 });

          const coalValues = [...new Set(excelData.map(r => r["Coal"]).filter(v => v))];

          [coalDrop1, coalDrop2, coalDrop3].forEach(drop=>{
            drop.innerHTML="";
            let empty = document.createElement("option");
            empty.value = ""; empty.textContent = "-- Select Coal --";
            drop.appendChild(empty);
            coalValues.forEach(c=>{
              let opt=document.createElement("option");
              opt.value=c; opt.textContent=c; drop.appendChild(opt);
            });
          });

          attachAutoUpdate();

        } catch(err){console.error(err); alert("Error reading file.");}
        finally{document.getElementById("loader").style.display="none";}
      },500);
    };
    reader.readAsArrayBuffer(file);
  }

  function getValue(coalName, key){
    const row=excelData.find(r=>r["Coal"]===coalName);
    return row ? parseFloat(row[key])||0 : 0;
  }

  function calcAFT(ox){
    const total = Object.values(ox).reduce((a,b)=>a+b,0);
    if(total === 0) return "0 (No Blend)";
    const sum = ox["SiO₂"] + ox["Al₂O₃"];
    let aft=0, slag="";
    if(sum<55){
      aft=1245+(1.1*ox["SiO₂"])+(0.95*ox["Al₂O₃"])-(2.5*ox["Fe₂O₃"])-(2.98*ox["CaO"])-(4.5*ox["MgO"])-(7.89*(ox["Na₂O"]+ox["K₂O"]))-(1.7*ox["SO₃"])-(0.63*ox["TiO₂"]);
      slag="High";
    }else if(sum<75){
      aft=1323+(1.45*ox["SiO₂"])+(0.683*ox["Al₂O₃"])-(2.39*ox["Fe₂O₃"])-(3.1*ox["CaO"])-(4.5*ox["MgO"])-(7.49*(ox["Na₂O"]+ox["K₂O"]))-(2.1*ox["SO₃"])-(0.63*ox["TiO₂"]);
      slag="Medium";
    }else{
      aft=1395+(1.2*ox["SiO₂"])+(0.9*ox["Al₂O₃"])-(2.5*ox["Fe₂O₃"])-(3.1*ox["CaO"])-(4.5*ox["MgO"])-(7.2*(ox["Na₂O"]+ox["K₂O"]))-(1.7*ox["SO₃"])-(0.63*ox["TiO₂"]);
      slag="Low";
    }
    return aft.toFixed(2);
  }

  function updateGCVBoxes(){
    const coal1=document.getElementById("coalDrop1").value;
    const coal2=document.getElementById("coalDrop2").value;
    const coal3=document.getElementById("coalDrop3").value;
    document.getElementById("gcvBox1").innerText=coal1?getValue(coal1,"GCV"):"--";
    document.getElementById("gcvBox2").innerText=coal2?getValue(coal2,"GCV"):"--";
    document.getElementById("gcvBox3").innerText=coal3?getValue(coal3,"GCV"):"--";
  }

  function calculateBlended(){
    const coal1=document.getElementById("coalDrop1").value;
    const coal2=document.getElementById("coalDrop2").value;
    const coal3=document.getElementById("coalDrop3").value;

    let totalFlow=0;
    let weightedGCV=0;
    let weightedAFT=0;

    const mills=document.querySelectorAll(".mill.red");
    mills.forEach(m=>{
      let sibs=[], node=m;
      for(let i=0;i<6;i++){node=node.nextElementSibling; sibs.push(node);}
      const perc1=parseFloat(sibs[0].querySelector("input")?.value)||0;
      const perc2=parseFloat(sibs[1].querySelector("input")?.value)||0;
      const perc3=parseFloat(sibs[2].querySelector("input")?.value)||0;
      const flow=parseFloat(sibs[3].querySelector("input")?.value)||0;
      const gcvDiv=sibs[4];
      const aftDiv=sibs[5];

      const gcv1=getValue(coal1,"GCV"), gcv2=getValue(coal2,"GCV"), gcv3=getValue(coal3,"GCV");
      let blended=((gcv1*(perc1/100))+(gcv2*(perc2/100))+(gcv3*(perc3/100)));
      gcvDiv.innerText=blended.toFixed(2);

      const oxKeys = ["SiO₂","Al₂O₃","Fe₂O₃","CaO","MgO","Na₂O","K₂O","SO₃","TiO₂"];
      let ox = {};
      oxKeys.forEach(k => {
        ox[k] = ((getValue(coal1,k) * (perc1 / 100)) +
                 (getValue(coal2,k) * (perc2 / 100)) +
                 (getValue(coal3,k) * (perc3 / 100)));
      });

      const aftVal = parseFloat(calcAFT(ox));
      aftDiv.innerText = aftVal.toFixed(2);

      if(flow>0){
        totalFlow+=flow;
        weightedGCV+=(flow*blended);
        weightedAFT+=(flow*aftVal);
      }
    });

    const avgGCV = totalFlow>0 ? (weightedGCV/totalFlow).toFixed(2) : 0;
    const avgAFT = totalFlow>0 ? (weightedAFT/totalFlow).toFixed(2) : "--";

    document.getElementById("totalFlow").innerText = totalFlow.toFixed(2);
    document.getElementById("avgGCV").innerText = avgGCV;
    document.getElementById("avgAFT").innerText = avgAFT;

    const generation = parseFloat(document.getElementById("generation").value)||0;
    if(generation>0){
      const heatRate=(totalFlow*avgGCV)/generation;
      document.getElementById("heatRate").innerText = heatRate.toFixed(2);
    } else {
      document.getElementById("heatRate").innerText = "--";
    }
  }

  function attachAutoUpdate() {
    document.querySelectorAll(".percentage-input, .coal-input, #generation, .cost-input")
      .forEach(inp => inp.addEventListener("input", calculateBlended));

    ["coalDrop1","coalDrop2","coalDrop3"].forEach(id=>{
      document.getElementById(id).addEventListener("change", ()=>{
        updateGCVBoxes();
        calculateBlended();
      });
    });
  }
</script>

</body>
</html>
